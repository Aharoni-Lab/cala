noob_id: long-recording
noob_model: noob.tube.TubeSpecification
noob_version: 0.1.1.dev118+g64d81b7

assets:
  buffer:
    type: cala.assets.Buffer
    params:
      size: 100
    scope: runner
  footprints:
    type: cala.assets.Footprints
    params:
      sparsify: True
    scope: runner
  traces:
    type: cala.assets.Traces
    scope: runner
    params:
      zarr_path: traces/
      peek_size: 100
      flush_interval: 1000
  pix_stats:
    type: cala.assets.PixStats
    scope: runner
  comp_stats:
    type: cala.assets.CompStats
    scope: runner
  overlaps:
    type: cala.assets.Overlaps
    scope: runner
  residuals:
    type: cala.assets.Buffer
    params:
      size: 100
    scope: runner


nodes:
  source:
    type: cala.nodes.io.stream
    params:
      subdir: long_recording
      extension: .avi
  counter:
    type: cala.nodes.prep.counter
  frame:
    type: cala.nodes.prep.package_frame
    depends:
      - frame: source.value
      - index: counter.idx

  #PREPROCESS BEGINS
  hotpix:
    type: cala.nodes.prep.blur
    params:
      method: median
      kwargs:
        ksize: 3
    depends:
      - frame: frame.value
  flatten:
    type: cala.nodes.prep.butter
    params:
      kwargs:
        cutoff_frequency_ratio: 0.010
    depends:
      - frame: hotpix.frame
  lines:
    type: cala.nodes.prep.remove_mean
    params:
      orient: both
    depends:
      - frame: flatten.frame
  motion:
    type: cala.nodes.prep.Anchor
    depends:
      - frame: lines.frame
  glow:
    type: cala.nodes.prep.GlowRemover
    depends:
      - frame: motion.frame
  gather:
    type: gather
    params:
      n: 4
    depends:
      - glow.frame
  downsample: # 20fps -> 5fps
    type: cala.nodes.prep.downsample
    params:
      x_range: [ 250, 350 ]
      y_range: [ 250, 350 ]
      t_downsample: 4
    depends:
      - frames: gather.value
  size_est:
    type: cala.nodes.prep.SizeEst
    params:
      hardset_radius: 8
    depends:
      - frame: downsample.frame
  cache:
    type: cala.nodes.buffer.fill_buffer
    depends:
      - buffer: assets.buffer
      - frame: downsample.frame
  #PREPROCESS ENDS

  # FRAME UPDATE BEGINS
  trace_frame:
    type: cala.nodes.traces.Tracer
    params:
      tol: 0.001
      max_iter: 100
    depends:
      - traces: assets.traces
      - footprints: assets.footprints
      - frame: downsample.frame
      - overlaps: assets.overlaps
  pix_frame:
    type: cala.nodes.pixel_stats.ingest_frame
    depends:
      - pixel_stats: assets.pix_stats
      - frame: downsample.frame
      - new_traces: trace_frame.latest_trace
      - footprints: assets.footprints
  comp_frame:
    type: cala.nodes.component_stats.ingest_frame
    depends:
      - component_stats: assets.comp_stats
      - frame: downsample.frame
      - new_traces: trace_frame.latest_trace
  footprints_frame:
    type: cala.nodes.footprints.Footprinter
    params:
      bep: 0
      tol: 0.0001
      max_iter: 5
      ratio_lb: 0.10
    depends:
      - footprints: assets.footprints
      - pixel_stats: pix_frame.value
      - component_stats: comp_frame.value

  residual:
    type: cala.nodes.residual.Residuer
    depends:
      - frame: downsample.frame
      - footprints: footprints_frame.footprints
      - traces: assets.traces
      - residuals: assets.residuals
  # FRAME UPDATE ENDS

  # DETECT BEGINS
  nmf:
    type: cala.nodes.detect.SliceNMF
    params:
      min_frames: 100
      detect_thresh: 8.0
      reprod_tol: 0.005
    depends:
      - residuals: residual.movie
      - energy: residual.std
      - detect_radius: size_est.radius
  catalog:
    type: cala.nodes.detect.Cataloger
    params:
      age_limit: 100
      shape_smooth_kwargs:
        ksize: [ 5, 5 ]
        sigmaX: 0
      trace_smooth_kwargs:
        sigma: 2
      merge_threshold: 0.9
      val_threshold: 0.5
      cnt_threshold: 5
    depends:
      - new_fps: nmf.new_fps
      - new_trs: nmf.new_trs
      - existing_fp: assets.footprints
      - existing_tr: assets.traces
  detect_update:
    type: cala.nodes.detect.update_assets
    depends:
      - new_footprints: catalog.new_footprints
      - new_traces: catalog.new_traces
      - footprints: assets.footprints
      - traces: assets.traces
      - pixel_stats: assets.pix_stats
      - component_stats: assets.comp_stats
      - overlaps: assets.overlaps
      - buffer: assets.buffer
  #  DETECT ENDS

  save_trace:
    type: cala.nodes.io.save_asset
    params:
      target_epoch: 855999 #  formula: 1000 * n_chunks - 1
      path: traces_fin/
    depends:
      - asset: assets.traces
      - curr_epoch: counter.idx

  save_shape:
    type: cala.nodes.io.save_asset
    params:
      target_epoch: 855999 #  formula: 1000 * n_chunks - 1
      path: footprints_fin/
    depends:
      - asset: assets.footprints
      - curr_epoch: counter.idx

#  merge:
#    type: cala.nodes.merge.merge_existing
#    params:
#      merge_interval: 500
#      merge_threshold: 0.95
#      smooth_kwargs:
#        sigma: 2
#    depends:
#      - shapes: assets.footprints
#      - traces: assets.traces
#      - overlaps: assets.overlaps
#      - trigger: detect_update.footprints
#  merge_update:
#    type: cala.nodes.detect.update_assets
#    depends:
#      - new_footprints: merge.footprints
#      - new_traces: merge.traces
#      - footprints: assets.footprints
#      - traces: assets.traces
#      - pixel_stats: assets.pix_stats
#      - component_stats: assets.comp_stats
#      - overlaps: assets.overlaps
#      - buffer: assets.buffer
