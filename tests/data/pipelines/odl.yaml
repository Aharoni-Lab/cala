noob_id: cala-odl
noob_model: noob.tube.TubeSpecification
noob_version: 0.1.1.dev118+g64d81b7

assets:
  buffer:
    type: cala.assets.Buffer
    params:
      size: 100
    scope: runner
  footprints:
    type: cala.assets.Footprints
    params:
      sparsify: True
    scope: runner
  traces:
    type: cala.assets.Traces
    params:
      zarr_path: traces/
      peek_size: 100
      flush_interval: 200
    scope: runner
  pix_stats:
    type: cala.assets.PixStats
    scope: runner
  comp_stats:
    type: cala.assets.CompStats
    scope: runner
  overlaps:
    type: cala.assets.Overlaps
    scope: runner
  residuals:
    type: cala.assets.Buffer
    params:
      size: 100
    scope: runner

nodes:
  source:
    type: cala.testing.SingleCellSource
  counter:
    type: cala.nodes.prep.counter
  frame:
    type: cala.nodes.prep.package_frame
    depends:
      - frame: source.frame
      - index: counter.idx

  #PREPROCESS BEGINS
  glow:
    type: cala.nodes.prep.GlowRemover
    depends:
      - frame: frame.value
  radius:
    type: cala.nodes.prep.SizeEst
    params:
      hardset_radius: 5
    depends:
      - frame: glow.frame
  cache:
    type: cala.nodes.omf.pixel_stats.fill_buffer
    depends:
      - buffer: assets.buffer
      - frame: glow.frame
  #PREPROCESS ENDS

  ingest:
    type: tube
    params:
      tube: ingest-loop
    depends:
      - frame: glow.frame
      - traces: assets.traces
      - footprints: assets.footprints
      - overlaps: assets.overlaps
      - pix_stats: assets.pix_stats
      - comp_stats: assets.comp_stats
      - residuals: assets.residuals

  segment:
    type: tube
    params:
      tube: segment-loop
    depends:
      - residual: assets.residuals
      - energy: ingest.value
      - radius: radius.radius
      - footprints: assets.footprints
      - traces: assets.traces
      - frame_sum: assets.pix_stats
      - trace_sum: assets.comp_stats
      - overlaps: assets.overlaps
      - buffer: assets.buffer

  return:
    type: return
    depends:
      - raw: frame.value
      - prep: glow.frame