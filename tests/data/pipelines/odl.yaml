noob_id: cala-odl
noob_model: noob.cube.CubeSpecification
noob_version: 0.1.1.dev118+g64d81b7

# Add GUI server in assets

assets:
  buffer:
    type: cala.assets.Movie
    scope: session
    depends:
      - cache.buffer
  footprints:
    type: cala.assets.Footprints
    scope: session
  traces:
    type: cala.assets.Traces
    scope: session
  pix_stats:
    type: cala.assets.PixStats
    scope: session
  comp_stats:
    type: cala.assets.CompStats
    scope: session
  overlaps:
    type: cala.assets.Overlaps
    scope: session

# Add refiners in nodes

nodes:
  source:
    type: cala.testing.single_cell_source
    params:
      n_frames: 30
  denoise:
    type: cala.nodes.prep.denoise
    params:
      ksize:
      - 3
      - 3
      sigmaX: 1.5
    depends:
    - frame: source.frame
  glow:
    type: cala.nodes.prep.GlowRemover
    depends:
    - frame: denoise.frame
  motion:
    type: cala.nodes.prep.RigidStabilizer
    params:
      drift_speed: 1.0
    depends:
    - frame: glow.frame
  cache:
    type: cala.nodes.buffer.fill_buffer
    params:
      size: 100
    depends:
      - buffer: assets.buffer
      - frame: motion.frame

  trace_frame:
    type: cala.nodes.traces.FrameUpdate
    params:
      tolerance: 0.001
    depends:
      - traces: assets.traces
      - footprints: assets.footprints
      - frame: motion.frame
      - overlaps: assets.overlaps

  pix_frame:
    type: cala.nodes.pixel_stats.ingest_frame
    depends:
      - pixel_stats: assets.pix_stats
      - frame: motion.frame
      - new_traces: trace_frame.latest_trace
  comp_frame:
    type: cala.nodes.component_stats.ingest_frame
    depends:
      - component_stats: assets.comp_stats
      - frame: motion.frame
      - new_traces: trace_frame.latest_trace

  residual:
    type: cala.nodes.residual.build
    params:
      clip_threshold: 0.001
    depends:
      - trigger: trace_frame.latest_trace
      - frames: assets.buffer
      - footprints: assets.footprints
      - traces: assets.traces

# DETECT BEGINS
  energy:
    type: cala.nodes.detect.Energy
    params:
      gaussian_std: 1.0
      min_frames: 10
    depends:
      - residuals: residual.movie
      - trigger: trace_frame.latest_trace
  nmf:
    type: cala.nodes.detect.SliceNMF
    params:
      cell_radius: 10
      validity_threshold: 0.9
    depends:
      - residuals: residual.movie
      - energy: energy.energy
  sniff:
    type: cala.nodes.detect.DupeSniffer
    params:
      merge_threshold: 0.8
    depends:
      - new_fp: nmf.new_fp
      - new_tr: nmf.new_tr
      - existing_fp: assets.footprints
      - existing_tr: assets.traces
      - residuals: residual.movie
  catalog:
    type: cala.nodes.detect.Cataloger
    depends:
      - new_fp: nmf.new_fp
      - new_tr: nmf.new_tr
      - existing_fp: assets.footprints
      - existing_tr: assets.traces
      - duplicates: sniff.dupes

  trace_component:
    type: cala.nodes.traces.ingest_component
    depends:
      - traces: assets.traces
      - new_trace: catalog.new_trace
  footprint_component:
    type: cala.nodes.footprints.ingest_component
    depends:
      - footprints:  assets.footprints
      - new_footprint: catalog.new_footprint
  pix_component:
    type: cala.nodes.pixel_stats.ingest_component
    depends:
      - pixel_stats: assets.pix_stats
      - frames: assets.buffer
      - new_trace: catalog.new_trace
      - traces: assets.traces
  comp_component:
    type: cala.nodes.component_stats.ingest_component
    depends:
      - component_stats: assets.comp_stats
      - traces: assets.traces
      - new_trace: catalog.new_trace
  overlaps_update:
    type: cala.nodes.overlap.ingest_component
    depends:
      - overlaps: assets.overlaps
      - footprints: assets.footprints
      - new_footprints: catalog.new_footprint
#  DETECT ENDS

  footprints_frame:
    type: cala.nodes.footprints.Footprinter
    params:
      bep: 1
      tol: 0.0000001
    depends:
      - footprints: assets.footprints
      - pixel_stats: pix_component.value
      - component_stats: comp_component.value

  return:
    type: return
    depends:
      - motion.frame