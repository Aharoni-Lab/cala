noob_id: cala-io
noob_model: noob.tube.TubeSpecification
noob_version: 0.1.1.dev118+g64d81b7

assets:
  buffer:
    type: cala.assets.Movie
    scope: session
    depends:
      - cache.buffer
  footprints:
    type: cala.assets.Footprints
    scope: session
  traces:
    type: cala.assets.Traces
    scope: session
  pix_stats:
    type: cala.assets.PixStats
    scope: session
  comp_stats:
    type: cala.assets.CompStats
    scope: session
  overlaps:
    type: cala.assets.Overlaps
    scope: session
  residuals:
    type: cala.assets.Residual
    scope: session


nodes:
  source:
    type: cala.nodes.io.stream
    params:
      files:
      - data/movies/msCam1.avi
  counter:
    type: cala.util.counter
  frame:
    type: cala.util.package_frame
    depends:
      - frame: source.value
      - index: counter.idx

  #PREPROCESS BEGINS
  saltpepper:
    type: cala.nodes.prep.denoise
    params:
      method: median
      kwargs:
        ksize: 3
    depends:
      - frame: frame.value
  denoise:
    type: cala.nodes.prep.denoise
    params:
      method: nonlocal
      kwargs:
        h: 4
        templateWindowSize: 7
        searchWindowSize: 21
    depends:
      - frame: saltpepper.frame
  lines:
    type: cala.nodes.prep.hlines.remove
    depends:
      - frame: glow.frame
  glow:
    type: cala.nodes.prep.GlowRemover
    depends:
      - frame: denoise.frame
  smooth:
    type: cala.nodes.prep.denoise
    params:
      method: gaussian
      kwargs:
        ksize: [ 7, 7 ]
        sigmaX: 1.5
    depends:
      - frame: lines.frame
  motion:
    type: cala.nodes.prep.RigidStabilizer
    params:
      drift_speed: 0.5
    depends:
      - frame: smooth.frame
  size_est:
    type: cala.nodes.prep.SizeEst
    params:
      noise_threshold: 2.0
      n_frames: 30
      log_kwargs:
        min_sigma: 3
        max_sigma: 10
        num_sigma: 10
        threshold: 0.2
        overlap: 0.5
    depends:
      - frame: motion.frame
  cache:
    type: cala.nodes.buffer.fill_buffer
    params:
      size: 100
    depends:
      - buffer: assets.buffer
      - frame: motion.frame
  #PREPROCESS ENDS

  # FRAME UPDATE BEGINS
  trace_frame:
    type: cala.nodes.traces.FrameUpdate
    params:
      tol: 0.001
      max_iter: 100
    depends:
      - traces: assets.traces
      - footprints: assets.footprints
      - frame: motion.frame
      - overlaps: assets.overlaps
  pix_frame:
    type: cala.nodes.pixel_stats.ingest_frame
    depends:
      - pixel_stats: assets.pix_stats
      - frame: motion.frame
      - new_traces: trace_frame.latest_trace
  comp_frame:
    type: cala.nodes.component_stats.ingest_frame
    depends:
      - component_stats: assets.comp_stats
      - frame: motion.frame
      - new_traces: trace_frame.latest_trace
  footprints_frame:
    type: cala.nodes.footprints.Footprinter
    params:
      bep: 1
      tol: 0.0001
      max_iter: 100
    depends:
      - footprints: assets.footprints
      - pixel_stats: pix_frame.value
      - component_stats: comp_frame.value
  facetune:
    type: cala.nodes.cleanup.clear_overestimates
    params:
      nmf_error: 1.0
    depends:
      - footprints: footprints_frame.footprints
      - residuals: assets.residuals

  residual:
    type: cala.nodes.residual.build
    depends:
      - frames: assets.buffer
      - footprints: footprints_frame.footprints
      - traces: assets.traces
      - residuals: assets.residuals
  cleanup:
    type: cala.nodes.cleanup.purge_razed_components
    params:
      min_thicc: 3
    depends:
      - footprints: assets.footprints
      - traces: assets.traces
      - pix_stats: assets.pix_stats
      - comp_stats: assets.comp_stats
      - overlaps: assets.overlaps
      - trigger: residual.movie
  # FRAME UPDATE ENDS

  # DETECT BEGINS
  nmf:
    type: cala.nodes.detect.SliceNMF
    params:
      min_frames: 30
      detect_thresh: 2.0
      reprod_tol: 0.005
    depends:
      - residuals: residual.movie
      - detect_radius: size_est.radius
  catalog:
    type: cala.nodes.detect.Cataloger
    params:
      merge_threshold: 0.8
    depends:
      - new_fps: nmf.new_fps
      - new_trs: nmf.new_trs
      - existing_fp: assets.footprints
      - existing_tr: assets.traces

  trace_component:
    type: cala.nodes.traces.ingest_component
    depends:
      - traces: assets.traces
      - new_traces: catalog.new_traces
  footprint_component:
    type: cala.nodes.footprints.ingest_component
    depends:
      - footprints:  assets.footprints
      - new_footprints: catalog.new_footprints
  pix_component:
    type: cala.nodes.pixel_stats.ingest_component
    depends:
      - pixel_stats: assets.pix_stats
      - frames: assets.buffer
      - new_traces: catalog.new_traces
      - traces: assets.traces
  comp_component:
    type: cala.nodes.component_stats.ingest_component
    depends:
      - component_stats: assets.comp_stats
      - traces: assets.traces
      - new_traces: catalog.new_traces

  overlaps_update:
    type: cala.nodes.overlap.initialize
    depends:
      - overlaps: assets.overlaps
      - footprints: footprint_component.footprints
  #  DETECT ENDS

  return:
    type: return
    depends:
      - raw: frame.value
      - prep: motion.frame